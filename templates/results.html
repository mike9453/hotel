<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分析結果</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h2>
        評論列表 ({{ reviews|length }} 筆，{{ start_year }} ~ {{ end_year }})
      </h2>
      <ul class="list-group mb-4">
        {% for r in reviews %}
        <li class="list-group-item">
          <strong>{{ r.author }}</strong>
          <span class="badge bg-success ms-2">{{ r.rating }}★</span>
          <div class="small text-muted">{{ r.time_txt }}</div>
          <p class="mb-0">{{ r.text }}</p>
        </li>
        {% endfor %}
      </ul>

      <h3>星等分佈</h3>
      <div class="mb-4">
        {% for star, count in rating_counts.items() %}
        <span class="me-3">{{ star }}★: <strong>{{ count }}</strong></span>
        {% endfor %}
      </div>

      <h3>關鍵字統計 (Top 20)</h3>
      <!-- Bar Chart Container -->
      <div class="card mb-4">
        <div class="card-body">
          <canvas id="keywordChart" height="100"></canvas>
        </div>
      </div>

      <hr />
      <h3>向 AI 提問</h3>
      <form method="post" action="/ask" class="needs-validation" novalidate>
        <textarea name="reviews_json" hidden>{{ reviews|tojson }}</textarea>
        <div class="mb-3">
          <label for="user_question" class="form-label">你的問題</label>
          <input
            type="text"
            class="form-control"
            id="user_question"
            name="user_question"
            placeholder="例如：請幫我整理出最常被提到的優缺點"
            required
          />
          <div class="invalid-feedback">請輸入你的問題</div>
        </div>
        <button type="submit" class="btn btn-success">送出問題</button>
      </form>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js Initialization -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('keywordChart').getContext('2d');
        const data = {
          labels: {{ stats | map(attribute='keyword') | list | tojson }},
          datasets: [{
            label: '關鍵字出現次數',
            data: {{ stats | map(attribute='count') | list | tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        };
        new Chart(ctx, {
          type: 'bar',
          data: data,
          options: {
            scales: {
              x: { beginAtZero: true },
              y: { beginAtZero: true }
            }
          }
        });
      });
      // Bootstrap 表單驗證
      (function () {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      })();
    </script>
  </body>
</html>
